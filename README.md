## 阶段七：引入消息队列实现下单异步写库与库存扣减

### 1. 技术目标

- 利用 RabbitMQ 实现下单流程的异步化，提升系统性能和解耦能力。
- 订单写库与库存扣减解耦，采用最终一致性方案，提升高并发下的系统稳定性。

### 2. 关键实现步骤

1. **RabbitMQ 环境与依赖配置**
   - 使用 Docker Compose 部署 RabbitMQ 服务，配置账号、密码、虚拟主机。
   - Spring Boot 项目中引入 `spring-boot-starter-amqp` 依赖，并配置连接信息。

2. **消息结构与发送**
   - 设计 `OrderMessage`、`OrderItemMessage` 消息体，采用 JSON 格式传递订单信息。
   - 下单时，订单与订单项写库成功后，发送订单消息到 RabbitMQ。

3. **交换机、队列与路由键**
   - 通过配置类声明 Direct Exchange、队列和路由键，实现消息的精确路由。

4. **异步消费与库存扣减**
   - 编写消息监听器（Listener），异步消费订单消息，批量校验并扣减库存。
   - 若库存不足或并发扣减失败，订单状态更新为“FAILED”；全部成功则更新为“SUCCESS”。

5. **订单状态管理**
   - 订单表增加 `status` 字段，初始为“PENDING”，根据库存扣减结果异步更新为“SUCCESS”或“FAILED”。

6. **可靠性与可观测性**
   - 使用 Jackson2JsonMessageConverter 实现消息体的 JSON 序列化，便于跨语言和后台查看。
   - 通过日志输出和 RabbitMQ 管理后台，实时观察消息流转和队列消费情况。

### 3. 业务与技术要点

- **异步解耦**：下单流程与库存扣减解耦，提升系统吞吐量和用户体验。
- **最终一致性**：通过消息队列和订单状态管理，实现订单与库存的最终一致性。
- **并发安全**：批量扣减库存时，结合数据库原子操作和受影响行数校验，防止超卖。
- **可观测性**：通过日志和RabbitMQ后台，便于调试和问题定位。
- **灵活调试**：可通过注释监听器暂停消费，观察消息堆积和订单中间状态。

### 4. 测试建议

- 正常下单、库存不足、并发下单等场景均已覆盖，订单状态和库存扣减均能正确反映业务结果。
