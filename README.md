# ç¬¬å…­é˜¶æ®µï¼šSharding-JDBC åˆ†åº“åˆ†è¡¨

æœ¬é˜¶æ®µç›®æ ‡æ˜¯ä½¿ç”¨ Sharding-JDBC å®ç°æŒ‰ `user_id` è¿›è¡Œåˆ†åº“ã€æŒ‰ `order_id` è¿›è¡Œåˆ†è¡¨çš„è¯»å†™åˆ†ç¦»æ¶æ„ã€‚

---

## ğŸ¯ é¡¹ç›®ç»“æ„ä¸ç›®æ ‡

- ä»¥ `order` ä¸ºä¸»è¡¨ï¼ŒæŒ‰ `user_id` åˆ†åº“ï¼ˆ`ds0`, `ds1`ï¼‰
- `order` è¡¨æŒ‰ `id` åˆ†è¡¨ï¼ˆ`order_0`, `order_1`ï¼‰
- `order_item` è¡¨è·Ÿéš `order` è¡¨æŒ‰ `order_id` åˆ†è¡¨ï¼ˆ`order_item_0`, `order_item_1`ï¼‰
- è¯»å†™åˆ†ç¦»æ¶æ„ä¿ç•™ï¼ˆä¸ç¬¬äº”é˜¶æ®µå…¼å®¹ï¼‰
- ä½¿ç”¨é›ªèŠ±ç®—æ³•è‡ªåŠ¨ç”Ÿæˆå…¨å±€å”¯ä¸€ä¸»é”®
- å¼€å‘ç¯å¢ƒä¸éƒ¨ç½²ç¯å¢ƒä¿æŒä¸€è‡´çš„é…ç½®æ–¹å¼ï¼Œå®ç°ä»£ç ä¸å˜å³å¯åˆ‡æ¢è¿è¡Œç¯å¢ƒ

---

## âš™ï¸ é…ç½®è¯´æ˜ï¼ˆsharding-prod.yml / sharding-dev.ymlï¼‰

### 1. æ•°æ®æºé…ç½®

```yaml
dataSources:
  ds0:
    url: jdbc:mysql://mysql-ds0-master:3306/ecommerce_ds0...
  ds1:
    url: jdbc:mysql://mysql-ds1-master:3306/ecommerce_ds1...
```

ä¸¤ä¸ªä¸»åº“ç»„æˆçš„åˆ†åº“ç»“æ„ï¼Œé…åˆè¯»å†™åˆ†ç¦»ä¸­é…ç½®çš„ä¸»ä»æ•°æ®æºåï¼ˆds0, ds1ï¼‰ã€‚

### 2. åˆ†åº“ç­–ç•¥

```yaml
shardingAlgorithms:
  db_inline:
    type: INLINE
    props:
      algorithm-expression: ds${user_id % 2}
```

æŒ‰ `user_id` è·¯ç”±åˆ° `ds0` æˆ– `ds1`ã€‚

### 3. åˆ†è¡¨ç­–ç•¥

```yaml
shardingAlgorithms:
  order_table_inline:
    type: INLINE
    props:
      algorithm-expression: order_${id % 2}

  order_item_table_inline:
    type: INLINE
    props:
      algorithm-expression: order_item_${order_id % 2}
```

è¯´æ˜ï¼š

- `order.id` ä½œä¸ºä¸»é”®è·¯ç”±è§„åˆ™ï¼ˆå¿…é¡»èƒ½å–åˆ°è¯¥å€¼ï¼‰
- `order_item.order_id` ä½œä¸ºä»è¡¨è·¯ç”±è§„åˆ™
- æ³¨æ„ï¼šç®—æ³•è¡¨è¾¾å¼ä¸­ä¸èƒ½å«ç©ºæ ¼ï¼Œå¿…é¡»ç¬¦åˆ `${}` è¯­æ³•

---

## ğŸ§  é‡åˆ°çš„é—®é¢˜ä¸æ’æŸ¥è®°å½•

### âœ… æˆåŠŸè§£å†³çš„é—®é¢˜

| é—®é¢˜ | åŸå› åˆ†æ | è§£å†³æ–¹æ¡ˆ |
|------|-----------|------------|
| `order_item_${order_id%2}` æŠ¥é”™è¡¨è¾¾å¼ä¸åˆ†ç‰‡é”®ä¸åŒ¹é… | åˆ†ç‰‡é”®åœ¨ SQL ä¸­æ— æ³•æ­£ç¡®è¯†åˆ« | `insert` æ—¶æœªè®¾ç½® `useGeneratedKeys` å¯¼è‡´ä¸»é”®ä¸ºç©º |
| æœ¬åœ°æ— æ³•è°ƒè¯• | é…ç½®æ–‡ä»¶ä»…é€‚ç”¨äºå®¹å™¨ç¯å¢ƒï¼Œä¸»æœºåæ— æ³•è§£æ | å¤åˆ¶ `sharding-prod.yml` ä¸º `sharding-dev.yml`ï¼Œå°†è¿æ¥æ”¹ä¸º `localhost` |
| IDE å¯åŠ¨è®¿é—®æ•°æ®åº“å¤±è´¥ | å®¹å™¨å†…æ•°æ®åº“å `mysql-ds-master` åœ¨å®¿ä¸»æœºä¸­æ— æ³•è§£æ | æœ¬åœ°è°ƒè¯•ç”¨ `localhost` æ›¿æ¢æ•°æ®åº“è¿æ¥é…ç½® |

---

## ğŸ’¡ æ³¨æ„äº‹é¡¹ä¸ç»éªŒæ€»ç»“

1. Sharding-JDBC è¡¨è¾¾å¼å†™æ³•ä¸è¦å¸¦ç©ºæ ¼ï¼Œå¦‚ `order_${id % 2}`ã€‚
2. ä¸€å®šç¡®ä¿ insert æ—¶ä¸»é”®å­—æ®µæœ‰å€¼ï¼Œå¦åˆ™åˆ†è¡¨è¡¨è¾¾å¼å–ä¸åˆ°å€¼ã€‚
3. å¦‚æœä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆä¸»é”®ï¼ŒMyBatis ä¾ç„¶è¦é…ç½® `useGeneratedKeys="true" keyProperty="id"`ã€‚
4. `order_id` åœ¨ `order` è¡¨ä¸­å« `id`ï¼Œåœ¨ `order_item` ä¸­å« `order_id`ï¼Œè¡¨è¾¾å¼è¦åŒ¹é…å®ä½“ç±»å­—æ®µåã€‚
5. æœ¬åœ°å¼€å‘å¯ä»¥é€šè¿‡ `sharding-dev.yml` + ä¿®æ”¹æ•°æ®åº“è¿æ¥ä¸º `localhost` çš„æ–¹å¼å®ç°è°ƒè¯•ï¼Œä¸éœ€è¦æ¢é…ç½®ç»“æ„ã€‚

---

## ğŸ›  æœ¬åœ°ä¸å®¹å™¨è”è°ƒå»ºè®®

- Dockerå®¹å™¨å¯åŠ¨æ—¶æš´éœ²ç«¯å£ï¼š
  ```yaml
  ports:
    - 3306:3306
    - 6379:6379
  ```
- `application-dev.yml` ä¸­ï¼š
  ```yaml
  spring:
    datasource:
      url: jdbc:shardingsphere:classpath:sharding-dev.yml
    redis:
      host: localhost
  ```

ç¡®ä¿å®¹å™¨ MySQLã€Redis æœåŠ¡çš„ç«¯å£æ˜ å°„æ­£ç¡®ï¼Œå¼€å‘ç¯å¢ƒé…ç½®æœ¬åœ°è¿æ¥å³å¯ã€‚

---

## âœ… é˜¶æ®µç»“è®º

- âœ… å®ç°äº†æŒ‰ user_id åˆ†åº“ã€order_id åˆ†è¡¨çš„å®Œæ•´ç­–ç•¥
- âœ… å¼€å‘ä¸éƒ¨ç½²é…ç½®ç»Ÿä¸€ï¼Œè°ƒè¯•ä¸éƒ¨ç½²äº’ä¸å½±å“
- âœ… è§£å†³äº†ç”Ÿæˆä¸»é”®ä¸ºç©ºã€é…ç½®æ¨¡å¼æŠ¥é”™ç­‰å…³é”®é—®é¢˜